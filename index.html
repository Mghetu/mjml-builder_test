<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GrapesJS + MJML (Local)</title>
  <!-- Local GrapesJS CSS -->
  <link rel="stylesheet" href="./vendor/grapesjs/grapes.min.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #gjs { height: 100vh; }
  </style>
</head>
<body>
  <div id="gjs"></div>

  <!-- Local GrapesJS core -->
  <script src="./vendor/grapesjs/grapes.min.js"></script>
  <!-- Local MJML plugin (built/copied to vendor/grapesjs-mjml.umd.js) -->
  <script src="./vendor/grapesjs-mjml.umd.js"></script>

  <script>
    // Simple starter MJML (no <mj-head> to avoid canvas errors)
    const STARTER = `
<mjml>
  <mj-body background-color="#f4f4f4">
    <mj-section background-color="#ffffff">
      <mj-column>
        <mj-text align="center" font-size="22px" font-weight="700">Hello MJML</mj-text>
        <mj-text>Vanilla GrapesJS + MJML.</mj-text>
      </mj-column>
    </mj-section>
  </mj-body>
</mjml>`.trim();

    // Try common globals exposed by the UMD/iife build
    function getMjmlPlugin() {
      return (
        window.grapesjsMjml ||           // esbuild --global-name=grapesjsMjml
        window['grapesjs-mjml'] ||       // some UMD builds
        window.grapesjsMJML ||           // fallback alias
        window.grapesjs_plugin_mjml      // fallback alias
      );
    }

    // Wait a tick for both scripts to attach their globals
    (function start(tries = 0) {
      const hasCore = typeof window.grapesjs === 'function';
      const hasPlugin = typeof getMjmlPlugin() === 'function';
      if (!hasCore || !hasPlugin) {
        if (tries > 100) { console.error('Boot timeout: core or plugin not available'); return; }
        return setTimeout(() => start(tries + 1), 20);
      }

      // Clean start (avoid stale autosaved projects)
      localStorage.removeItem('mjml-editor-project');
      localStorage.removeItem('gjs-project-mjml-editor-project');

      const editor =
