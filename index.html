<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>Vanilla GrapesJS + MJML</title>

  <!-- GrapesJS core CSS -->
  <link rel="stylesheet" href="https://unpkg.com/grapesjs@0.22.13/dist/css/grapes.min.css" />

  <style>
    html, body { height: 100%; margin: 0; }
    #gjs { height: 100vh; }
  </style>
</head>
<body>
  <div id="gjs"></div>

  <!-- GrapesJS core -->
  <script src="https://unpkg.com/grapesjs@0.22.13/dist/grapes.min.js"></script>

  <!-- GrapesJS MJML plugin (UMD from official package) -->
  <script src="https://unpkg.com/grapesjs-mjml@1.0.7/dist/index.umd.js"></script>

  <script>
    // ---------- Head-free starter MJML ----------
    const STARTER = `
<mjml>
  <mj-body background-color="#f4f4f4">
    <mj-section background-color="#ffffff">
      <mj-column>
        <mj-text align="center" font-size="22px" font-weight="700">Hello MJML</mj-text>
        <mj-divider border-color="#e5e5e5" />
        <mj-text>Vanilla GrapesJS + MJML setup.</mj-text>
        <mj-button href="https://example.com">Call to action</mj-button>
      </mj-column>
    </mj-section>
  </mj-body>
</mjml>`.trim();

    // Safely resolve the MJML plugin function from the UMD build
    function getMjmlPlugin() {
      return (
        window.grapesjsMjml ||           // common global
        window['grapesjs-mjml'] ||       // alt global
        window.grapesjsMJML ||           // fallback
        window.grapesjs_plugin_mjml      // fallback
      );
    }

    // Wait for both GrapesJS and the plugin to be present, then init
    (function startWhenReady() {
      const hasCore = typeof window.grapesjs === 'function';
      const hasPlugin = typeof getMjmlPlugin() === 'function';
      if (!hasCore || !hasPlugin) {
        return setTimeout(startWhenReady, 10);
      }

      // Clean start: don't autoload any old saved project
      localStorage.removeItem('mjml-editor-project');
      localStorage.removeItem('gjs-project-mjml-editor-project');

      const editor = window.grapesjs.init({
        container: '#gjs',
        height: '100%',
        fromElement: false,

        // Keep storage off for a pristine vanilla demo
        storageManager: {
          type: 'local',
          autosave: false,
          autoload: false,
          options: { local: { key: 'mjml-editor-project' } },
        },

        // Our stable device set; we'll keep these IDs
        deviceManager: {
          devices: [
            { id: 'Desktop', name: 'Desktop', width: '' },
            { id: 'Tablet',  name: 'Tablet',  width: '620px' },
            { id: 'Mobile',  name: 'Mobile',  width: '320px' },
          ],
        },
      });

      // Manually register the MJML plugin (bullet-proof)
      const mjml = getMjmlPlugin();
      mjml(editor, {
        importPlaceholder: STARTER,
        resetDevices: false,      // keep our device IDs
        resetStyleManager: true,
        overwriteExport: true,    // MJML/HTML export modal
      });

      // Seed the canvas and add minimal device buttons
      editor.on('load', () => {
        editor.setComponents(STARTER);

        // Minimal device toolbar (keeps vanilla look)
        const pn = editor.Panels;
        pn.addPanel({ id: 'devices' });
        pn.addButton('devices', [
          { id: 'dev-desktop', label: 'Desktop', command: () => editor.setDevice('Desktop') },
          { id: 'dev-tablet',  label: 'Tablet',  command: () => editor.setDevice('Tablet') },
          { id: 'dev-mobile',  label: 'Mobile',  command: () => editor.setDevice('Mobile') },
        ]);

        // Optional: hide Head blocks from the Blocks sidebar (UI cleanliness)
        const bm = editor.BlockManager;
        ['mj-attributes','mj-style','mj-font','mj-preview'/*,'mj-raw'*/].forEach(id => { try { bm.remove(id); } catch(e){} });
      });
    })();
  </script>
</body>
</html>
